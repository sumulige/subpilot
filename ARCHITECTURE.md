# ğŸ—ï¸ é¡¹ç›®æ¶æ„ä¸æ ¸å¿ƒé€»è¾‘è§£æ

> æœ¬æ–‡æ¡£é¢å‘æ‰€æœ‰äººï¼Œè§£é‡Šè¿™ä¸ªå­—å¹•ç¿»è¯‘å™¨çš„è®¾è®¡æ€æƒ³å’Œå…³é”®ä»£ç é€»è¾‘ã€‚

---

## æ•´ä½“æ¶æ„ï¼šä¸‰å±‚è®¾è®¡


```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç”¨æˆ·ç•Œé¢ (UI Layer)                      â”‚
â”‚  src/app/page.tsx   â†’  ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶ã€ç‚¹å‡»æŒ‰é’®ã€æŸ¥çœ‹è¿›åº¦            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚ (è°ƒç”¨)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ç¿»è¯‘å¼•æ“ (Engine Layer)                    â”‚
â”‚  src/lib/engine/batcher.ts  â†’  æ ¸å¿ƒï¼æ™ºèƒ½åˆ†æ‰¹ + å¹¶å‘æ§åˆ¶          â”‚
â”‚  src/lib/engine/cache.ts    â†’  ç¼“å­˜å·²ç¿»è¯‘å†…å®¹ï¼Œé¿å…é‡å¤è°ƒç”¨       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚ (è°ƒç”¨)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æœåŠ¡æä¾›å•† (Provider Layer)                 â”‚
â”‚  src/lib/providers/doubao.ts  â†’  ä¸è±†åŒ…APIé€šä¿¡                  â”‚
â”‚  src/lib/providers/openai.ts  â†’  ä¸OpenAI APIé€šä¿¡               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒé€»è¾‘

### 1. ä¸ºä»€ä¹ˆéœ€è¦"åˆ†æ‰¹"ï¼Ÿ

**é—®é¢˜ï¼š** å‡è®¾ä½ æœ‰ä¸€ä¸ª 1000 è¡Œçš„å­—å¹•æ–‡ä»¶ï¼Œå¦‚æœä¸€è¡Œä¸€è¡Œå‘ç»™ AIï¼Œä½ éœ€è¦è°ƒç”¨ 1000 æ¬¡ APIã€‚è¿™å¤ªæ…¢äº†ï¼

**è§£å†³æ–¹æ¡ˆï¼š** æŠŠå¤šè¡Œæ–‡å­—"æ‰“åŒ…"æˆä¸€ä¸ªè¯·æ±‚å‘é€ã€‚

```typescript
// æ¯”å¦‚æŠŠ 5 è¡Œå­—å¹•åˆå¹¶æˆä¸€ä¸ªè¯·æ±‚
const batch = [
    "Hello",
    "How are you?",
    "Fine, thanks.",
    "Goodbye!",
    "See you."
].join("\n%%\n"); // ç”¨ %% ä½œä¸ºåˆ†éš”ç¬¦

// å‘é€ç»™ AI åï¼ŒAI è¿”å›ï¼š
// "ä½ å¥½\n%%\nä½ å¥½å—ï¼Ÿ\n%%\nå¾ˆå¥½ï¼Œè°¢è°¢.\n%%\nå†è§ï¼\n%%\nå›å¤´è§ã€‚"

// ç„¶åæˆ‘ä»¬å†æŒ‰ %% æ‹†åˆ†å› 5 è¡Œ
```

**ä½ç½®ï¼š** [batcher.ts](src/lib/engine/batcher.ts) `createBatches` å‡½æ•°ï¼ˆç¬¬ 154-188 è¡Œï¼‰

---

### 2. ä¸ºä»€ä¹ˆéœ€è¦"å¹¶å‘æ§åˆ¶"ï¼Ÿ

**é—®é¢˜ï¼š** å‡è®¾ä½ æœ‰ 100 ä¸ªæ‰¹æ¬¡ï¼Œå¦‚æœåŒæ—¶å‘é€ 100 ä¸ªè¯·æ±‚ï¼ŒæœåŠ¡å™¨å¯èƒ½ä¼šæ‹’ç»ä½ ï¼ˆè¿”å› 429 Too Many Requests é”™è¯¯ï¼‰ã€‚

**è§£å†³ï¼š** æ§åˆ¶åŒæ—¶å‘é€çš„è¯·æ±‚æ•°é‡ï¼ˆæ¯”å¦‚æœ€å¤š 50 ä¸ªï¼‰ã€‚

**ä¸¾ä¾‹ï¼š** æƒ³è±¡ä¸€ä¸ªé¤å…åªæœ‰ 50 ä¸ªåº§ä½ã€‚å³ä½¿æœ‰ 100 ä¸ªå®¢äººæƒ³è¿›æ¥ï¼Œä¹Ÿåªèƒ½è®© 50 ä¸ªäººå…ˆåä¸‹ï¼Œå…¶ä»–äººæ’é˜Ÿç­‰ç€ã€‚

```typescript
function createLimiter(concurrency: number) {
    let active = 0; // å½“å‰æ­£åœ¨å¤„ç†çš„è¯·æ±‚æ•°
    const queue = []; // æ’é˜Ÿç­‰å¾…çš„è¯·æ±‚

    return async (fn) => {
        if (active < concurrency) {
            active++;
            await fn(); // ç›´æ¥æ‰§è¡Œ
            active--;
        } else {
            queue.push(fn); // æ’é˜Ÿç­‰å¾…
        }
    };
}
```

**ä½ç½®ï¼š** [batcher.ts](src/lib/engine/batcher.ts) `createLimiter` å‡½æ•°ï¼ˆç¬¬ 597-630 è¡Œï¼‰

---

### 3. Provider ç³»ç»Ÿï¼šå¦‚ä½•æ”¯æŒå¤šä¸ª AI æœåŠ¡ï¼Ÿ

**é—®é¢˜ï¼š** ç”¨æˆ·å¯èƒ½æƒ³ç”¨è±†åŒ…ã€ä¹Ÿå¯èƒ½æƒ³ç”¨ OpenAIã€DeepSeek... ä½ ä¸å¯èƒ½ä¸ºæ¯ä¸ªæœåŠ¡å†™ä¸€å¥—å®Œå…¨ä¸åŒçš„ä»£ç ã€‚

**è§£å†³æ–¹æ¡ˆï¼š** å®šä¹‰ä¸€ä¸ªç»Ÿä¸€çš„æ¥å£ (`Provider`)ï¼Œæ‰€æœ‰æœåŠ¡éƒ½å®ç°è¿™ä¸ªæ¥å£ã€‚

```typescript
// ç»Ÿä¸€æ¥å£ (src/lib/types.ts)
interface Provider {
    id: string;
    translate(req: TranslationRequest): Promise<TranslationResult>;
}

// è±†åŒ…å®ç°
class DoubaoProvider implements Provider {
    async translate(req) { /* è°ƒç”¨è±†åŒ… API */ }
}

// OpenAI å®ç°
class OpenAIProvider implements Provider {
    async translate(req) { /* è°ƒç”¨ OpenAI API */ }
}
```

**å¥½å¤„ï¼š** å¼•æ“ä»£ç  (`batcher.ts`) ä¸éœ€è¦çŸ¥é“å…·ä½“ç”¨çš„æ˜¯å“ªä¸ªæœåŠ¡ï¼Œåªéœ€è¦è°ƒç”¨ `provider.translate()` å°±è¡Œã€‚

**ä½ç½®ï¼š** [types.ts](src/lib/types.ts) `Provider` æ¥å£ï¼ˆç¬¬ 44-50 è¡Œï¼‰

---

### 4. ä¸Šä¸‹æ–‡æ³¨å…¥ï¼šè®© AI "è®°ä½"å‰æ–‡

**é—®é¢˜ï¼š** AI ç¿»è¯‘å•ç‹¬ä¸€å¥è¯æ—¶ï¼Œå¯èƒ½ä¸çŸ¥é“è¯­å¢ƒã€‚æ¯”å¦‚ "He" æŒ‡çš„æ˜¯è°ï¼Ÿ

**è§£å†³æ–¹æ¡ˆï¼š** åœ¨æ¯ä¸ªè¯·æ±‚é‡Œé™„åŠ ä¸Šä¸‹æ–‡ï¼ˆå‰å‡ è¡Œçš„ç¿»è¯‘ç»“æœ + åå‡ è¡Œçš„åŸæ–‡ï¼‰ã€‚

```
PREVIOUS CONTEXT (å·²ç¿»è¯‘):
ç¬¬8å¥çš„ç¿»è¯‘
ç¬¬9å¥çš„ç¿»è¯‘

FUTURE CONTEXT (åŸæ–‡):
ç¬¬15å¥çš„åŸæ–‡
ç¬¬16å¥çš„åŸæ–‡
```

**ä½ç½®ï¼š** [batcher.ts](src/lib/engine/batcher.ts) `fillBatchContext` å‡½æ•°ï¼ˆç¬¬ 210-239 è¡Œï¼‰

---

### 5. ç¼“å­˜æœºåˆ¶ï¼šé¿å…é‡å¤ç¿»è¯‘

**é—®é¢˜ï¼š** å¦‚æœç”¨æˆ·ç¿»è¯‘åŒä¸€ä¸ªæ–‡ä»¶ä¸¤æ¬¡ï¼Œç¬¬äºŒæ¬¡è¿˜è¦é‡æ–°è°ƒç”¨ API å—ï¼Ÿ

**è§£å†³ï¼š** ä½¿ç”¨æµè§ˆå™¨ IndexedDB ç¼“å­˜ç¿»è¯‘ç»“æœã€‚ç›¸åŒçš„æ–‡æœ¬ä¸ä¼šé‡å¤è¯·æ±‚ AIã€‚

```typescript
// 1. ç”Ÿæˆå”¯ä¸€çš„ç¼“å­˜ Keyï¼ˆåŸºäºæ–‡æœ¬å†…å®¹çš„å“ˆå¸Œå€¼ï¼‰
const cacheKey = cache.key(batch.mergedText, "doubao:en:zh");

// 2. æŸ¥è¯¢ç¼“å­˜
const cachedResult = await cache.get(cacheKey);

// 3. åˆ¤æ–­æ˜¯å¦å‘½ä¸­
if (cachedResult) {
    // âœ… å‘½ä¸­ç¼“å­˜ï¼ç›´æ¥ä½¿ç”¨ï¼Œä¸è°ƒç”¨ API
    translatedText = cachedResult;
} else {
    // âŒ æœªå‘½ä¸­ï¼Œè°ƒç”¨ AI API
    const result = await provider.translate(...);
    
    // å­˜å…¥ç¼“å­˜ï¼ˆä¸‹æ¬¡å°±èƒ½å‘½ä¸­äº†ï¼‰
    await cache.set(cacheKey, translatedText);
}
```

| æ¦‚å¿µ | è§£é‡Š |
|---|---|
| **Cache Key** | ç”± `æ–‡æœ¬å†…å®¹ + æä¾›å•† + æºè¯­è¨€ + ç›®æ ‡è¯­è¨€` ç”Ÿæˆçš„å”¯ä¸€æ ‡è¯† |
| **å‘½ä¸­æ¡ä»¶** | Key å®Œå…¨ä¸€è‡´æ‰ä¼šå‘½ä¸­ã€‚æ”¹ä¸€ä¸ªå­—ã€æ¢ä¸€ä¸ªè¯­è¨€ï¼Œéƒ½ä¼šç”Ÿæˆæ–°çš„ Key |
| **å­˜å‚¨ä½ç½®** | æµè§ˆå™¨ IndexedDBï¼Œå…³é—­æµè§ˆå™¨ä¹Ÿä¸ä¼šä¸¢å¤± |

**ä½ç½®ï¼š** [cache.ts](src/lib/engine/cache.ts) å’Œ [batcher.ts](src/lib/engine/batcher.ts) ç¬¬ 317-325 è¡Œ

---

## æŸ¥çœ‹è·¯å¾„å»ºè®®

1.  **`page.tsx`**ï¼šè¿™æ˜¯å…¥å£ï¼Œçœ‹çœ‹ç”¨æˆ·æ“ä½œæ˜¯å¦‚ä½•è§¦å‘ç¿»è¯‘çš„ã€‚
2.  **`batcher.ts`**ï¼šè¿™æ˜¯æ ¸å¿ƒï¼Œç†è§£ `createBatches` å’Œ `translateWithBatching`ã€‚
3.  **çœ‹ä¸€ä¸ª Provider**ï¼šæ¯”å¦‚ `doubao.ts`ï¼Œçœ‹çœ‹å¦‚ä½•è°ƒç”¨å¤–éƒ¨ APIã€‚
4.  **è¿è¡Œé¡¹ç›®**ï¼šè‡ªå·±æ”¹æ”¹å‚æ•°ï¼ˆå¹¶å‘æ•°ã€æ‰¹æ¬¡å¤§å°ï¼‰ï¼Œè§‚å¯Ÿæ—¥å¿—å˜åŒ–ã€‚

---

## ğŸ“ å…³é”®æ–‡ä»¶é€ŸæŸ¥

| æ–‡ä»¶ | ä½œç”¨ |
|---|---|
| `src/app/page.tsx` | ç”¨æˆ·ç•Œé¢ï¼Œå¤„ç†æ–‡ä»¶ä¸Šä¼ å’Œç¿»è¯‘æŒ‰é’® |
| `src/lib/engine/batcher.ts` | **æ ¸å¿ƒå¼•æ“**ï¼Œæ™ºèƒ½åˆ†æ‰¹ + å¹¶å‘æ§åˆ¶ |
| `src/lib/engine/cache.ts` | ç¼“å­˜å±‚ï¼Œé¿å…é‡å¤ç¿»è¯‘ |
| `src/lib/providers/*.ts` | AI æœåŠ¡é€‚é…å™¨ï¼ˆè±†åŒ…ã€OpenAI ç­‰ï¼‰ |
| `src/lib/types.ts` | ç±»å‹å®šä¹‰ï¼ˆæ¥å£ã€é…ç½®é¡¹ï¼‰ |
| `src/app/api/translate/route.ts` | Next.js API è·¯ç”±ï¼Œä»£ç† AI è¯·æ±‚ |
